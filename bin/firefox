#!/bin/bash
set -euf

DOTFILES="${DOTFILES:-$HOME/.dotfiles}"
[ -d "$DOTFILES" ] && export HOME="$DOTFILES"

export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"

PROFILE="$XDG_DATA_HOME/firefox/default"

# init profile
if [ ! -d "$PROFILE" ] ; then
    mkdir -p -- "$(readlink -- "$PROFILE")"
    cp -r -- "$XDG_CONFIG_HOME/firefox/default/." "$PROFILE/"
    git clone "https://github.com/Aris-t2/CustomCSSforFx" "$PROFILE/chrome/CustomCSSforFx"
    "$XDG_CONFIG_HOME/firefox/user.js/generate.py" | sort > "$PROFILE/user.js"
fi

PROFILE_RUNTIME="$XDG_DATA_HOME/firefox/default"
if [[ ! "$PROFILE_RUNTIME" -ef "$PROFILE" ]] ; then
    mkdir -p -- "$(readlink -- "$PROFILE_RUNTIME")"
    rsync -av -- "$PROFILE/" "$PROFILE_RUNTIME/"
    sync() {
         echo "sync"
         rsync -av -- "$PROFILE_RUNTIME/" "$PROFILE/"
    }
    ( while true ; do
        for i in {1..100} ; do sleep 6 ; echo -n '.' ; done
        sync
    done ) &
    PID=$!
    cleanup() {
        echo "cleanup"
        kill $PID || true
        sync
    }
    trap cleanup EXIT
fi

CMD=(
    /usr/bin/firefox
    --profile "$PROFILE_RUNTIME"
    "$@"
)

"${CMD[@]}"
