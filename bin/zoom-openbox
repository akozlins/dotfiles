#!/bin/bash
set -euf

PRIVATE="$XDG_DATA_HOME/zoom"
mkdir -pv -- "$PRIVATE/.config/openbox"

cat > "$PRIVATE/.config/openbox/autostart" << EOF
fbpanel &
terminal &
/usr/bin/zoom "$@" &
EOF

MY_W=1000
MY_H=1000
if command -v xprop &> /dev/null ; then
    WORKAREA=($(xprop -root ' $0 $1 $2 $3' _NET_WORKAREA))
    MY_W=$(( (WORKAREA[3] - WORKAREA[1])*7/8 ))
    MY_H=$(( (WORKAREA[4] - WORKAREA[2])*7/8 ))
fi

MY_DISPLAY=1
while [ -e "/tmp/.X11-unix/X$MY_DISPLAY" ] ; do
    MY_DISPLAY=$((MY_DISPLAY + 1))
done

MY_XEPHYR_OPTS=(
    # create root window with black background
    -br
    # do not reset after last client exits
    -noreset
    # WIDTH[/WIDTHMM]xHEIGHT[/HEIGHTMM][+[-]XOFFSET][+[-]YOFFSET][@ROTATION][X][Y][xDEPTH/BPP[xFREQ]]
    -screen "${MY_W}x${MY_H}"
)

CMD=(
    /usr/bin/xinit

    # run openbox-session under bwrap
    /usr/bin/bwrap
    --dev /dev
    --proc /proc
    --tmpfs /tmp
    --ro-bind /bin /bin
    --ro-bind /etc /etc
    --ro-bind /lib64 /lib64
    --ro-bind /opt /opt
    --ro-bind /usr /usr
    --unshare-all
    --share-net
    --hostname bwrap-xephyr
    --die-with-parent
    --clearenv
    --setenv DISPLAY ":$MY_DISPLAY"
    #--bind "/tmp/.X11-unix/X$MY_DISPLAY" "/tmp/.X11-unix/X$MY_DISPLAY"

    --setenv HOME "$HOME"
    --bind "$PRIVATE" "$HOME"
    --bind "$XDG_RUNTIME_DIR/pulse" "$XDG_RUNTIME_DIR/pulse"
    #--bind "$XDG_RUNTIME_DIR/pipewire-0" "$XDG_RUNTIME_DIR/pipewire-0"
    --bind "$HOME/mu3e" "$HOME/mu3e"

    openbox-session

    # run Xephyr
    -- /usr/bin/Xephyr ":$MY_DISPLAY"
    "${MY_XEPHYR_OPTS[@]}"
)

exec "${CMD[@]}"
